<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Span-based multi-granularity word segment results display</title>
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入ECharts JS -->
    <script src="http://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
    <style>
        #treeChart {
            width: 100%;
            height: 420px;
        }
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1px;
            padding-top: 10px;
            margin-bottom: 1px;
            width: 250px;
            /*width: calc(50% - 10px); !* 考虑到padding和margin的影响 *!*/
        }
        .result-box h5{
            text-align: center; /* 居中文本 */
        }
        /*.result-box {*/
        /*    background-color: #f8f9fa;*/
        /*    border: 1px solid #dee2e6;*/
        /*    border-radius: 0.25rem;*/
        /*    padding: 10px;*/
        /*    margin-bottom: 15px;*/
        /*}*/
        /* 定义渐变背景色 */
    /* 定义渐变背景色 */
        /* 基础样式 */
        .gradient-btn {
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px; /* 可选：添加圆角 */
        }

        /* 定义不同级别的颜色 */
        .gradient-btn-0 { background: linear-gradient(to right, #d0eaff, #b0d4ff); }
        .gradient-btn-1 { background: linear-gradient(to right, #b0d4ff, #90c8ff); }
        .gradient-btn-2 { background: linear-gradient(to right, #90c8ff, #70baff); }
        .gradient-btn-3 { background: linear-gradient(to right, #70baff, #50a8ff); }
        .gradient-btn-4 { background: linear-gradient(to right, #50a8ff, #3097ff); }
        .gradient-btn-5 { background: linear-gradient(to right, #3097ff, #1087fb); }
        .gradient-btn-6 { background: linear-gradient(to right, #1087fb, #0078f7); }
        .gradient-btn-7 { background: linear-gradient(to right, #0078f7, #0068f2); }
        .gradient-btn-8 { background: linear-gradient(to right, #0068f2, #1d60bb); }
        .gradient-btn-9 { background: linear-gradient(to right, #1d60bb, #1d60bb); }
    </style>
</head>
<body>
    <!-- 容器 -->
    <div class="container mt-5">
        <!-- 输入区域 -->
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="inputText" placeholder="Please enter the text to be tokenized.">
                    <button class="btn btn-primary" type="button" id="segmentBtn">Word Segment</button>
                </div>
            </div>
        </div>
        <!-- 图表区域 -->
        <div class="row mt-4">
            <div class="col-md-10 offset-md-1">
                <div id="treeChart"></div>
            </div>
        </div>
        <!-- 结果展示区域 -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="result-box">
                    <h5>CTB guideline</h5>
                    <p id="result_ctb"></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="result-box">
                    <h5>MSR guideline</h5>
                    <p id="result_msr"></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="result-box">
                    <h5>PKU guideline</h5>
                    <p id="result_pku"></p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="result-box">
                    <h5>Candidate words</h5>
                    <p id="candidate Words"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- DOM 加载完成后执行脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const inputText = document.getElementById('inputText');
            const segmentBtn = document.getElementById('segmentBtn');
            const chartDom = document.getElementById('treeChart');
            const myChart = echarts.init(chartDom); // 初始化 ECharts 实例
            const result_ctb = document.getElementById('result_ctb');
            const result_msr = document.getElementById('result_msr');
            const result_pku = document.getElementById('result_pku');

            // 分词按钮点击事件
            segmentBtn.addEventListener('click', function() {
                const text = inputText.value.trim();
                if (text) { // 如果输入文本非空
                    fetchSegmentation(text); // 发起分词请求
                } else {
                    alert('Please enter the text to be tokenized.'); // 提示输入文本
                }
            });

            // 向服务器发送分词请求
            function fetchSegmentation(text) {
                fetch('http://127.0.0.1:5000/segment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 'sentence': text }), // 发送文本数据
                })
                .then(response => response.json()) // 解析JSON响应
                .then(data => {
                    // console.log(data);
                    renderTree(data.mws_res); // 渲染树状图
                    // updateResults(text, data); // 更新结果显示
					updateResults(data); // 更新结果显示
                })
                .catch((error) => {
                    console.error('Error:', error); // 打印错误信息
                    alert('An error occurred while retrieving the tokenization results.'); // 显示错误提示
                });
            }

            // 根据置信度计算颜色
            function getColor(value) {
                const hue = (1 - value) * 240; // 色相值从蓝色到红色变化
                return `hsl(${hue}, 100%, 50%)`; // 返回颜色字符串
            }

            // 渲染树状图
            function renderTree(data) {
                const option = {
                    tooltip: {
                        trigger: 'item', // 悬停在项目上显示提示
                        triggerOn: 'mousemove' // 当鼠标移动到项目上时触发
                    }, series: [
                        {
                            type: 'tree', // 图表类型为树状图
                            data: [data], // 数据源
                            top: '10%', // 上方留白
                            left: '7%', // 左侧留白
                            bottom: '15%', // 下方留白
                            right: '7%', // 右侧留白
                            symbolSize: 10, // 节点符号大小
                            orient: 'vertical', // 垂直方向布局
                            label: {
                                position: 'top', // 标签位置
                                rotate: 0, // 标签旋转角度
                                verticalAlign: 'middle', // 垂直对齐方式
                                align: 'center', // 水平对齐方式
                                fontSize: 16, // 字体大小
                                formatter: function(params) { // 格式化标签内容
                                    if (params.data.value !== null) {
                                        // return `{word|${params.name}}\n{value|${params.data.value.toFixed(2)}}`;
                                        return `{word|${params.name}}\n{value|${params.data.value.toFixed(2)}}`;
                                    }
                                    return `{word|${params.name}}`;
                                },
                                rich: { // 富文本样式
                                    word: {
                                        fontSize: 16,
                                        color:'black',
                                        backgroundColor: '#75c8e5',
                                        padding: [5, 10],
                                        borderRadius: 5
                                    },
                                    value: {
                                        color: '#090606',
                                        fontSize: 14
                                    }
                                }
                            },
                            leaves: { // 叶子节点的标签配置
                                label: {
                                    position: 'bottom',
                                    rotate: 0,
                                    verticalAlign: 'middle',
                                    align: 'center'
                                }
                            },
                            itemStyle: { // 节点样式
                                color: function(params) {
                                    if (params.data.value !== null) {
                                        return getColor(params.data.value); // 根据置信度设置颜色
                                    }
                                    return '#555'; // 非叶子节点的颜色
                                }
                            },
                            emphasis: { // 高亮配置
                                focus: 'descendant' // 高亮焦点及其后代
                            },
                            expandAndCollapse: true, // 允许展开和折叠
                            animationDuration: 550, // 动画持续时间
                            animationDurationUpdate: 750, // 更新动画持续时间
                            initialTreeDepth: 2 // 初始树深度
                        }
                    ]
                };

                myChart.setOption(option); // 应用图表配置
            }

            // 更新结果显示
            // function updateResults(text, data) {
            //     const wordCount = countWords(data); // 计算分词数量
            //     const avgConfidence = calculateAverageConfidence(data); // 计算平均置信度
            //     // result_ctb.textContent = `输入文本的长度：${text.length} 字符`; // 显示文本长度
            //     // result_msr.textContent = `分词数量：${wordCount} 个`; // 显示分词数量
            //     // result_pku.textContent = `平均置信度：${avgConfidence.toFixed(2)}`; // 显示平均置信度
            //     result_ctb.textContent='';
            // }
			function updateResults(jsonData) {
				console.log(jsonData)
			    document.getElementById('result_ctb').innerHTML = createButtons(jsonData.ctb_res);
			    document.getElementById('result_msr').innerHTML = createButtons(jsonData.msr_res);
			    document.getElementById('result_pku').innerHTML = createButtons(jsonData.pku_res);
			}
            // 计算分词数量
            function countWords(node) {
                if (!node.children || node.children.length === 0) {
                    return 1; // 如果是叶子节点返回1
                }
                return node.children.reduce((sum, child) => sum + countWords(child), 0); // 递归计算所有子节点
            }

            function createButtons(data) {
			    let html = '';
			        for (const [key, value] of Object.entries(data)) {
			            let btnClass = '';
                        if (value < 0.1) {
                            btnClass = 'gradient-btn gradient-btn-0';
                        } else if (value >= 0.1 && value < 0.2) {
                            btnClass = 'gradient-btn gradient-btn-1';
                        } else if (value >= 0.2 && value < 0.3) {
                            btnClass = 'gradient-btn gradient-btn-2';
                        } else if (value >= 0.3 && value < 0.4) {
                            btnClass = 'gradient-btn gradient-btn-3';
                        } else if (value >= 0.4 && value < 0.5) {
                            btnClass = 'gradient-btn gradient-btn-4';
                        } else if (value >= 0.5 && value < 0.6) {
                            btnClass = 'gradient-btn gradient-btn-5';
                        } else if (value >= 0.6 && value < 0.7) {
                            btnClass = 'gradient-btn gradient-btn-6';
                        } else if (value >= 0.7 && value < 0.8) {
                            btnClass = 'gradient-btn gradient-btn-7';
                        } else if (value >= 0.8 && value < 0.9) {
                            btnClass = 'gradient-btn gradient-btn-8';
                        } else if (value >= 0.9 && value <= 1.0) {
                            btnClass = 'gradient-btn gradient-btn-9';
                        }

			            html += `
			                <div class="btn-group" role="group">
			                    <button class="${btnClass}">${key}</button>
<!--			                    &nbsp;&nbsp;&nbsp; &lt;!&ndash; 添加空格 &ndash;&gt;-->
			                    <button class="${btnClass}">${value.toFixed(2)}</button>
			                </div><br />
			            `;
			        }
			        return html;
			}

            // 计算平均置信度
            function calculateAverageConfidence(node) {
                let sum = 0;
                let count = 0;

                // 递归遍历树结构
                function traverse(n) {
                    if (n.value !== null) {
                        sum += n.value;
                        count++;
                    }
                    if (n.children) {
                        n.children.forEach(traverse);
                    }
                }

                traverse(node); // 开始遍历
                return count > 0 ? sum / count : 0; // 计算平均值
            }
        });
    </script>
</body>
</html>